# v1.4.0 Implementation Plan - Quality & Coverage

> **Target**: Q1 2026
> **Theme**: Test Coverage & Security Hardening
> **Created**: January 25, 2026

---

## Executive Summary

Following the v1.3.0 Platform Modularity release, v1.4.0 focuses on **quality assurance** and **security hardening**. This release addresses:
- Test coverage gaps in 16 domains
- Security authentication vulnerabilities
- PHPStan Level 8 compliance
- Domain scaffolding tooling

---

## Current State Analysis

### Test Coverage Gaps

| Priority | Domain | Has Services | Has Models | Has Events | Status |
|----------|--------|-------------|------------|------------|--------|
| **Critical** | Fraud | Yes | Yes | Yes | No Tests |
| **Critical** | Regulatory | Yes | Yes | Yes | No Tests |
| **Critical** | Stablecoin | Yes | Yes | Yes | No Tests |
| **Critical** | Wallet | Yes | Yes | Yes | No Tests |
| High | AI | Yes | No | Yes | No Tests |
| High | Batch | Yes | Yes | Yes | No Tests |
| High | Cgo | Yes | Yes | Yes | No Tests |
| High | FinancialInstitution | Yes | Yes | Yes | No Tests |
| Medium | Monitoring | Yes | No | Yes | No Tests |
| Medium | Performance | Yes | Yes | Yes | No Tests |
| Medium | Product | Yes | Yes | Yes | No Tests |
| Medium | Webhook | Yes | Yes | No | No Tests |
| Low | Activity | No | Yes | No | No Tests |
| Low | Contact | No | Yes | No | No Tests |
| Low | Newsletter | Yes | Yes | No | No Tests |
| Low | Shared | No | No | Yes | No Tests |

### Security Issues

| Issue | Location | Severity |
|-------|----------|----------|
| Rate limiting allows 4 attempts instead of 3 | AuthenticationSecurityTest | High |
| Token expiration not enforced | AuthenticationSecurityTest | High |
| Token invalidation not immediate | AuthenticationSecurityTest | High |
| Scope-based authorization incomplete | AuthorizationSecurityTest | Medium |

### PHPStan Errors

**File**: `app/Domain/Account/Services/AccountQueryService.php`

| Line | Error | Fix Required |
|------|-------|--------------|
| 162, 177, 181 | Property access on model | Add PHPDoc or use proper accessors |
| 213, 217 | String column in where clause | Type annotations |
| 230, 235 | Collection map type | Add return type annotations |
| 242 | Method on wrong type | Fix toIso8601String call |
| 264 | Return type mismatch | Fix array shape |

---

## Implementation Phases

### Phase 1: Critical Fixes (Week 1)

#### 1.1 PHPStan Level 8 Compliance
- Fix 10 errors in AccountQueryService
- Add missing type annotations
- Update PHPStan baseline if needed

#### 1.2 Security Authentication Fixes
- Fix rate limiting threshold (3 attempts)
- Enforce token expiration
- Implement immediate token invalidation
- Add scope-based authorization

### Phase 2: Critical Domain Tests (Week 2)

#### 2.1 Fraud Domain Tests
```
tests/Domain/Fraud/
├── Services/
│   ├── FraudDetectionServiceTest.php
│   ├── FraudAlertServiceTest.php
│   └── RiskScoringServiceTest.php
├── Models/
│   └── FraudAlertTest.php
└── Events/
    └── FraudAlertEventsTest.php
```

#### 2.2 Regulatory Domain Tests
```
tests/Domain/Regulatory/
├── Services/
│   ├── RegulatoryReportingServiceTest.php
│   └── ComplianceSchedulerServiceTest.php
├── Models/
│   └── RegulatoryReportTest.php
└── Events/
    └── RegulatoryEventsTest.php
```

#### 2.3 Stablecoin Domain Tests
```
tests/Domain/Stablecoin/
├── Services/
│   ├── MintingServiceTest.php
│   ├── BurningServiceTest.php
│   └── ReserveManagementServiceTest.php
├── Aggregates/
│   └── StablecoinAggregateTest.php
└── Events/
    └── StablecoinEventsTest.php
```

#### 2.4 Wallet Domain Tests
```
tests/Domain/Wallet/
├── Services/
│   ├── WalletServiceTest.php
│   ├── TransactionServiceTest.php
│   └── BlockchainConnectorTest.php
├── Models/
│   └── WalletTest.php
└── Events/
    └── WalletEventsTest.php
```

### Phase 3: Domain Scaffolding (Week 3)

#### 3.1 Domain Create Command
```bash
php artisan domain:create {name}
    --type=optional
    --with-events
    --with-workflows
    --with-tests
```

Generates:
```
app/Domain/{Name}/
├── module.json
├── Services/
├── Models/
├── Events/
├── Contracts/
├── DataObjects/
├── Enums/
└── Exceptions/
```

#### 3.2 Domain Test Scaffold Command
```bash
php artisan domain:scaffold-tests {domain}
```

Generates test stubs for:
- All services (unit tests)
- All models (feature tests)
- All events (integration tests)

### Phase 4: High Priority Domain Tests (Week 4)

#### 4.1 AI Domain Tests
- MCPServerService tests
- ConversationService tests
- Tool execution tests

#### 4.2 Batch Domain Tests
- BatchProcessor tests
- Job scheduling tests
- Retry logic tests

#### 4.3 CGO Domain Tests
- Offering lifecycle tests
- Investment flow tests
- Distribution tests

#### 4.4 FinancialInstitution Domain Tests
- Institution management tests
- Integration tests
- Webhook tests

---

## Success Metrics

| Metric | Current | Target v1.4.0 |
|--------|---------|---------------|
| Test coverage | ~50% | 65% |
| Domains with tests | 13/29 | 21/29 |
| PHPStan errors | 10 | 0 |
| Security TODOs | 4 | 0 |
| Critical domains tested | 0/4 | 4/4 |

---

## Risk Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Test isolation issues | Medium | High | Use CleansUpSecurityState trait |
| Redis dependency in tests | High | High | Configure array cache for tests |
| Breaking changes | Low | Medium | Run full test suite before merge |
| Time constraints | Medium | Medium | Prioritize critical domains first |

---

## Files to Create

```
docs/V1.4.0_IMPLEMENTATION_PLAN.md           # This file

app/Infrastructure/Domain/Commands/
├── DomainCreateCommand.php                   # NEW
└── DomainScaffoldTestsCommand.php            # NEW

tests/Domain/Fraud/
├── Services/FraudDetectionServiceTest.php    # NEW
└── ...

tests/Domain/Regulatory/
├── Services/RegulatoryReportingServiceTest.php # NEW
└── ...

tests/Domain/Stablecoin/
├── Services/MintingServiceTest.php           # NEW
└── ...

tests/Domain/Wallet/
├── Services/WalletServiceTest.php            # NEW
└── ...
```

---

## Dependencies

- **v1.3.0**: Module manifest system (completed)
- **Upstream**: laravel-workflow package (LiquidityRetryPolicy blocked)
- **Infrastructure**: Redis or array cache configuration for tests

---

## Next Steps

1. **Immediate**: Fix PHPStan errors in AccountQueryService
2. **This Week**: Create domain:create scaffolding command
3. **Week 2**: Add tests for Fraud, Regulatory, Stablecoin, Wallet
4. **Week 3-4**: Expand test coverage to remaining domains

---

*Document Version: 1.0*
*Created: January 25, 2026*
